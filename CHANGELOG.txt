================================================================================
ASTERIA GAME - CHANGELOG
================================================================================

--------------------------------------------------------------------------------
CHANGELOG CONVENTIONS (pre-release)
--------------------------------------------------------------------------------

Workflow
1. Daily/WIP changes: Add to `docs/patch-notes/UNRELEASED.md`.
2. Weekly release: Move "Unreleased" content to `docs/patch-notes/0.x.y.md` and bump package version.

Versioning (recommended)
- Use pre-release SemVer: 0.MINOR.PATCH
  - PATCH: numeric tuning, bug fixes, UI copy
  - MINOR: new mechanic, new ability, new screen
  - MAJOR: reserved for 1.0 launch

Entry format
- Keep date headers in this file (dev log): YYYY-MM-DD
- Player-facing notes live in `docs/patch-notes/`


--------------------------------------------------------------------------------
2026-01-25 - Shield Bar UI & Frost Barrier Implementation
--------------------------------------------------------------------------------

ISSUE:
- Frost Barrier ability (Lyra) was not applying shield effect when cast
- No visual indicator for active shields in the UI

CHANGES:

1. src/components/ui/HealthBar.tsx
   - Added optional `shield` prop to HealthBarProps interface
   - Shield bar renders below health bar only when shield > 0
   - Shield amount displayed in cyan next to HP values: "85 / 85 (+34)"
   - Shield bar uses cyan color scheme (bg-cyan-400 / bg-cyan-950)
   - Bar width calculated as percentage of max HP

2. src/components/combat/HeroPanel.tsx
   - Extract shield value from hero.statusEffects (type === "shield")
   - Pass shieldAmount to HealthBar component

3. src/systems/combat/turnManager.ts
   - Added processAbilityEffects() method
   - Processes ability tags after damage calculation
   - Handles "shield" tag: applies 40% max HP shield for 2 turns
   - Handles "burn" tag: applies 5% max HP DoT for 3 turns
   - Logs and animations queued for each effect applied

--------------------------------------------------------------------------------
2026-01-25 - Frost Barrier Shatter Fix & Bar Height Increase
--------------------------------------------------------------------------------

ISSUE:
- Frost Barrier was applying chill immediately on cast instead of on shatter
- Bar heights were too thin

CHANGES:

1. src/components/ui/HealthBar.tsx
   - Doubled health bar height: h-2 -> h-4
   - Doubled shield bar height: h-1.5 -> h-3

2. src/systems/combat/turnManager.ts
   - Removed immediate "chill" application from processAbilityEffects()
   - Added handleShieldShatter() method to trigger shatter effects
   - Shield now stores shatter damage in snapshotAtk field when created
   - processAbilityEffects() now receives abilityScaling parameter

   Shield break detection (executeMonsterAttack):
   - Captures existing shield and shatter damage before absorption
   - Detects when shield is fully absorbed (broken)
   - Calls handleShieldShatter() with reason "broken"

   Shield expire detection (endRound):
   - Captures existing shield and shatter damage before duration tick
   - Checks if "shield" appears in expired effects list
   - Calls handleShieldShatter() with reason "expired"

   handleShieldShatter() behavior:
   - Logs whether shield was "broken" or "expired"
   - Deals shatter damage to monster (based on ability scaling)
   - Applies Chill to monster (15% less damage for 2 turns)

NOTES:
- Frost Barrier now correctly follows its description:
  1. On cast: Creates shield absorbing 40% max HP (no damage)
  2. On shatter (broken OR expired): Deals shatter damage, applies Chill
- Shatter damage is pre-calculated on cast and stored on the shield effect

--------------------------------------------------------------------------------
2026-01-25 - Frost Barrier No Initial Damage Fix
--------------------------------------------------------------------------------

ISSUE:
- Frost Barrier was dealing damage on cast, but should only deal damage on shatter

CHANGES:

1. src/systems/combat/turnManager.ts (executeAbility)
   - Added isShieldAbility check: `ability.tags?.includes("shield")`
   - Shield abilities skip the immediate damage application
   - Damage is only dealt when handleShieldShatter() is called

NOTES:
- Frost Barrier behavior is now:
  1. On cast: Creates shield (40% max HP), NO damage
  2. On shatter: Deals 60-120% ATK damage + applies Chill

--------------------------------------------------------------------------------
2026-01-25 - Shield Bar Animation System
--------------------------------------------------------------------------------

ISSUE:
- Shield bar needed smooth animations for damage absorption, breaking, and expiration
- React state batching was causing animations to be skipped

CHANGES:

1. src/components/ui/HealthBar.tsx
   - Shows bar when shield is defined (including value 0)
   - Hides bar when shield becomes undefined
   - Shield text (+X) only shows when value > 0
   - CSS transition (duration-300) handles smooth animations

2. src/components/combat/HeroPanel.tsx
   - Passes `shieldEffect?.value` (undefined when no shield, 0 when broken)

3. src/systems/combat/statusEffects.ts (processShieldAbsorption)
   - Returns `shieldBroken` flag
   - When shield breaks, keeps it at value 0 (not removed immediately)

4. src/systems/combat/turnManager.ts (executeMonsterAttack)
   - When shield breaks: set value to 0, wait 350ms, then remove
   - This allows bar to animate to 0% before disappearing

5. src/systems/combat/turnManager.ts (endRound)
   - When shield expires: two-step animation with delays
   - Step 1: Keep shield at current value (show damage absorption)
   - Step 2: After 350ms, set value to 0 (show expiration drain)
   - Step 3: After 350ms, remove shield and trigger shatter

STATE FLOW (shield breaks):
1. Monster attacks, shield absorbs all remaining damage
2. Shield value set to 0 → bar animates to 0%
3. After 350ms → shield removed, bar disappears
4. Shatter effect triggers (damage + chill)

STATE FLOW (shield expires):
1. Monster attacks → shield absorbs partial damage (example: 28 → 22)
2. Bar animates to ~26% (damage absorption)
3. End of turn detects expiration, keeps shield at 22
4. After 350ms → shield value set to 0
5. Bar animates to 0% (expiration drain)
6. After 350ms → shield removed, bar disappears
7. Shatter effect triggers (damage + chill)


--------------------------------------------------------------------------------
2026-01-27 - Liquid Glass Panels & Turn Counter Carousel
--------------------------------------------------------------------------------

ISSUE:
- Hero/Monster panels needed a distinct "liquid glass" surface without changing the whole UI theme
- Turn counter animation was sliding the entire row instead of shifting the window (1 | 2 | 3 -> 2 | 3 | 4)

CHANGES:

1. src/app/globals.css
   - Added `.liquid-panel` class (blur + saturation + translucent background + highlight sheen)
   - Added `.liquid-tile` class for avatar tiles (smaller glass surface)

2. src/components/combat/HeroPanel.tsx
   - Switched panel container to `liquid-panel`
   - Switched avatar container to `liquid-tile`

3. src/components/combat/MonsterPanel.tsx
   - Switched panel container to `liquid-panel`
   - Switched avatar container to `liquid-tile`

4. src/components/combat/CombatHeader.tsx
   - Reworked turn counter into a slot-based carousel
   - Left value exits, remaining values shift left via layout animation, new value enters on the right
   - Uses smooth fade + slight blur for enter/exit to avoid hard motion

5. src/components/combat/ActionBar.tsx
   - Renamed local variable `useAbility` -> `castAbility` to avoid React Hooks lint false-positive
   - No functional change (still calls combatStore.useAbility)


--------------------------------------------------------------------------------
2026-01-28 - Run Loop (Victory -> Continue), Phase Router, Shop/Death Screens
--------------------------------------------------------------------------------

ISSUE:
- After winning, there was no reliable "continue" flow (player could get stuck in victory/combat_end).
- The app rendered CombatLayout for all phases, so shop/death/summary phases had no real screens.
- Skip Turn flipped to monster_turn but never executed the monster turn.

CHANGES:

1. src/systems/combat/combatActions.ts
   - proceedToNextEncounter() now guards: only works when phase is "victory" and turnPhase is "combat_end"
   - When continuing directly to combat: resets encounter UI state (clearLog + resetTurn) before spawning next monster
   - Added performSkipTurn() to ensure skipping schedules the monster turn (same delay as normal hero->monster transition)

2. src/components/combat/ActionBar.tsx
   - Skip Turn button now calls performSkipTurn() (fixes "stuck in monster_turn" bug)

3. src/systems/combat/turnManager.ts
   - executeMonsterTurn() now hard-guards against stale timeouts:
     - returns early unless game.phase === "combat" and turnPhase === "monster_turn"

4. src/app/page.tsx
   - Added phase-based routing:
     - combat/victory: CombatLayout
     - shop: ShopScreen
     - death: DeathScreen
     - run_summary: RunSummaryScreen
     - hero_select: placeholder hero/difficulty picker

5. src/components/screens/ShopScreen.tsx
   - WIP shop screen with guaranteed escape hatch:
     - Continue to Fight (no encounter increment)
     - Skip Shop (increments shopsSkipped, then continues)

6. src/components/screens/DeathScreen.tsx
   - Minimal death screen with run stats and actions:
     - Try Again
     - Hero Select

7. src/components/screens/RunSummaryScreen.tsx
   - Minimal summary screen for ending a run intentionally:
     - Start New Run
     - Hero Select


--------------------------------------------------------------------------------
2026-01-28 - Victory UI (In-Arena Card, No Modal Overlay)
--------------------------------------------------------------------------------

ISSUE:
- Victory UI as a modal overlay felt heavy and could interfere with the layout.
- Victory panel size was pushing side panels.

CHANGES:

1. src/components/combat/BattleArena.tsx
   - Replaced the portrait/VS block with a centered Victory card when:
     - game.phase === "victory" AND turnPhase === "combat_end"
   - Buttons:
     - Next Encounter / Enter Shop (computed from next encounter + shop frequency)
     - End Run
   - Later tweaks:
     - Reduced width (max-w-md) and padding to avoid pushing side columns
     - Removed the extra run info block per UX feedback

2. src/components/combat/CombatLayout.tsx
   - Removed VictoryOverlay mount

3. src/components/combat/VictoryOverlay.tsx
   - Deleted (no longer used)


--------------------------------------------------------------------------------
2026-01-28 - Camira Full Kit Implementation
--------------------------------------------------------------------------------

ISSUE:
- Camira's passive and all abilities were defined in data but not implemented in combat.

CHANGES:

1. src/systems/combat/turnManager.ts
   - Implemented Camira:
     - Passive: every 3rd BASIC attack deals bonus damage
     - Passive: on crit restores 2-5 mana and reduces Rapid Fire cooldown by 1
     - Rapid Fire: two hits + lifesteal based on total damage
     - Forest Agility: evade buff for next incoming attack + permanent ATK/DEF, and level 5+ random permanent Max HP
     - Jackpot Arrow: extra penetration, crit stacking per use, bonus crystals on kill
   - Ensured evade is consumed after the next monster attack attempt


--------------------------------------------------------------------------------
2026-01-28 - Long-Term Combat Architecture Refactor (Ability/Passive Registries)
--------------------------------------------------------------------------------

ISSUE:
- TurnManager was starting to accumulate hero-specific branching (not scalable when adding heroes).
- Ability tags were freeform strings, so typos or unimplemented tags silently did nothing.
- Mixing orchestration (turn flow) with ability mechanics makes future features harder to add and test.

WHY THIS CHANGE:
- Separates "combat flow" from "content logic" so adding heroes is mostly adding data + small handlers.
- Creates a single place to implement shared mechanics (tags) once and reuse across heroes.
- Adds compile-time safety for tags, preventing silent no-ops from typos.

CHANGES:

1. src/types/common.ts
   - Added AbilityTag union type to define the allowed set of ability tags

2. src/types/hero.ts
   - Ability.tags now uses AbilityTag[] instead of string[]

3. New: src/systems/combat/abilities/registry.ts
   - Ability-id registry for custom abilities (currently holds Camira handlers)
   - Allows future heroes to add complex mechanics without bloating TurnManager

4. New: src/systems/combat/abilities/tags.ts
   - Tag handler registry for reusable effects
   - Migrated existing tag behaviors:
     - burn
     - shield

5. New: src/systems/combat/abilities/types.ts
   - Shared types for ability execution context/handlers

6. New: src/systems/combat/passives/registry.ts
   - Passive hook registry (by heroId)
   - Camira passive moved here (onCrit + onBasicAttackResolved)

7. New: src/systems/combat/passives/types.ts
   - Passive hook types (onCrit, onBasicAttackResolved)

8. src/systems/combat/turnManager.ts
   - Removed Camira-specific branching from core flow
   - Execution now:
     - Checks abilityRegistry[ability.id] for custom handlers
     - Otherwise runs generic damage pipeline + applyAbilityTags(tags)
     - Passive hooks fire via triggerOnCrit / triggerOnBasicAttackResolved


--------------------------------------------------------------------------------
2026-01-28 - Build / TypeScript Fixes
--------------------------------------------------------------------------------

ISSUE:
- next build failing due to type errors and missing MonsterType keys.

CHANGES:

1. src/systems/combat/statusEffects.ts
   - Bleed tick now guards snapshotAtk (undefined -> 0) to satisfy TS and prevent runtime NaNs

2. src/data/monsters/definitions.ts
   - Added missing monster definitions/exports for vampire/orc/dragon and included them in MONSTERS

--------------------------------------------------------------------------------
2026-01-28 - Testing Infrastructure, Balance Tools & Score System Refactor
--------------------------------------------------------------------------------

ISSUE:
- Camira kit had text/value mismatches for Jackpot Arrow and Passive triggers
- No way to verify hero balance or mechanic implementation without manual play
- Score system was flat (10 points per kill), making monster types irrelevant for scoring
- No automated testing suite configured

CHANGES:

1. HERO REFINEMENT (Camira)
   - Updated `src/data/heroes/camira.ts`: Fixed Jackpot Arrow crystal text (20-600 vs 25-1600)
   - Updated `src/data/heroes/camira.ts`: Clarified passive text to "Every 3rd basic attack"
   - Added comprehensive unit tests in `tests/camira.test.ts` for all abilities/passives

2. SIMULATION & BALANCE ENGINE
   - Created `tests/utils/simulation.ts`: Headless game loop for high-speed automated runs
   - Implemented smart decision engine for Camira (kill-range detection, mana reservation)
   - Added `tests/benchmark.test.ts`: automated multi-strat benchmark suite
   - Added `docs/BALANCE_AND_TESTING.md`: Documentation for balance workflows
   - Configured auto-report generation in `docs/balance/` for hero analysis

3. SCORE SYSTEM REFACTOR
   - Updated `src/types/monster.ts`: Added `score` to base stats and `scoreReward` to state
   - Updated `src/data/monsters/definitions.ts`: Implemented unique scores per monster type
   - Updated `src/stores/combatStore/monsterSlice.ts`: Wired monster score to runtime state
   - Updated `src/systems/combat/turnManager.ts`: Refactored victory scoring:
     `score = monster.scoreReward * difficultyMultiplier`

4. COMBAT ENGINE INSTRUMENTATION
   - Added logging for dodged/missed abilities in `TurnManager.ts` and `registry.ts`
   - Improved log parsing in simulation to track crits, dodges, and jackpot efficiency

5. PROJECT CLEANUP
   - Standardized on `vitest.config.mts`, removed duplicate config
   - Added `benchmark` and `benchmark:hero` scripts to `package.json`
   - Cleaned up build artifacts and updated `.gitignore`


--------------------------------------------------------------------------------
2026-01-29 - Shop System (Random Stat Items), Benchmark Report Generator & Balance Tuning
--------------------------------------------------------------------------------

ISSUE:
- Shop flow existed but was WIP: no real shop inventory, purchases didn't apply stats, and skip bonus rules were incomplete.
- Balance benchmarks were hard to trust: missing shop attribution, confusing end-state semantics, skip mode ambiguity, and unstable/overwritten reports.
- Mana items were overperforming in simulations; shop cadence needed iteration.

CHANGES:

1. SHOP SYSTEM (items, generation, purchases)
   - Added Random Stat item definitions (Offense/Defense/Ability) with level-scaling stats and costs.
     - src/data/items/definitions.ts
     - src/data/items/index.ts
   - Added shop offer generation: guaranteed category coverage, per-skip epic odds, potion offer, premium placeholders.
     - src/systems/shop/generateShopOffers.ts
   - Added shop slice to game store and wired shop state/actions.
     - src/stores/gameStore/shopSlice.ts
     - src/stores/gameStore/index.ts
     - src/stores/gameStore/types.ts
   - Purchases now apply to the hero immediately (including Max HP/Mana increasing current HP/Mana).
     - src/stores/combatStore/heroSlice.ts
     - src/stores/combatStore/types.ts
   - Shop UI now shows real offers, stock, and potion usage; skip button removed from inside shop.
     - src/components/screens/ShopScreen.tsx

2. SHOP FLOW UX
   - Victory now always shows "Next Encounter" and opens a shop prompt modal when a shop is available.
   - Modal provides: Enter Shop / Skip (+bonus crystals scaled by level).
     - src/components/combat/BattleArena.tsx
   - Fixed off-by-one/stale-state bug where entering shop could incorrectly advance to combat.
     - src/systems/combat/combatActions.ts

3. PROGRESSION + HUD
   - Added run EXP tracking and a simple EXP progress bar (hover shows current/needed).
     - src/stores/gameStore/types.ts
     - src/stores/gameStore/runSlice.ts
     - src/systems/combat/turnManager.ts
     - src/components/combat/CombatHeader.tsx
   - Header now shows crystals and EXP progress.

4. BENCHMARK REPORT GENERATOR (MARKDOWN)
   - Implemented deterministic, sectioned benchmark summary report generation to docs/balance/.
   - Added hard validation for SHOP_SKIP_MODE (never|alternate|other).
   - Added skip modes:
     - never: enter every shop
     - alternate: enter first shop, then every other
     - other: skip first shop, then every other
   - Added reporting for:
     - progression percentiles (Avg/P50/P90)
     - economy conversion (crystals from skips/spent/end)
     - shop behavior (opportunities vs entries, skip %, zero-buy %, item-only affordability)
     - affordability diagnostics (wallet/cost bands, affordable item counts, best item score)
     - Camira attribution (casts/enc, mana spend/restore, Rapid Fire healing, Jackpot bonus crystals)
   - Report filenames are collision-safe and include MMDDYY, hero, runs, skip mode, and HHMMSS.
     - tests/utils/simulation.ts
     - tests/benchmark.test.ts

5. BALANCE TUNING
   - Shop cadence unified to every 3 encounters for all difficulties.
     - src/lib/constants.ts
   - Updated Ability-category shop items (Mana Crystal / Arcane Focus / Wellspring Heart) stats/costs.
     - src/data/items/definitions.ts

6. DOCS
   - Updated docs/BALANCE_AND_TESTING.md to reflect current Vitest + benchmark workflow and report outputs.
     - docs/BALANCE_AND_TESTING.md

7. COMBAT ACTION TOOLTIP UX
   - Added a tooltip mode toggle in the Action Bar (Expanded default, Brief optional).
     - src/components/combat/ActionBar.tsx
   - Expanded tooltips now show level-resolved, stat-based values for passives and abilities across heroes (including
     contextual values like enemy missing HP and Shade contract state), with tightened paragraph-style copy and bolded
     key stats.
     - src/components/combat/ActionTooltips.tsx

 SUGGESTED NEXT FEATURES (today)
 - Premium class items: implement the 3 premium slots per shop (Section 12 tables) + real purchase effects.
 - Shop value shaping: add more common options per category (reduce "solved" dominance of Whetstone/Mana Crystal).
  - Run objective: define a real "clear" condition (boss / encounter target) so benchmarks can include meaningful success rates.


--------------------------------------------------------------------------------
2026-01-31 - Documentation Tracking, Patch Notes Workflow, Manual Run Traces & Manual Strategy
--------------------------------------------------------------------------------

OVERVIEW:
- Kept CHANGELOG.txt as the internal implementation log.
- Introduced player-facing patch notes (LoL-style) + an UNRELEASED -> weekly release workflow.
- Stopped ignoring docs/tests in git so balance/docs artifacts can be tracked (while keeping generated balance reports ignored).
- Experiment: implemented a manual run decision dataset + learned benchmark strategy, then reverted it (too heavy for now).
  - Kept: exported JSON runs in `runs/manual/` for possible future analysis.

SESSION 1 - PATCH NOTES + DOC STRUCTURE (player-facing)

1) docs/patch-notes/
   - Added player-facing patch notes file:
     - docs/patch-notes/0.1.1.md
   - Added rolling weekly buffer:
     - docs/patch-notes/UNRELEASED.md
   - Added workflow instructions:
     - docs/patch-notes/README.md

2) docs/heroes/
   - Updated hero docs to support per-hero tracking:
     - Added/standardized an `Unreleased` section (WIP changes) and versioned entries.
     - Updated existing hero docs (Bran/Camira/Lyra/Shade + future hero placeholders) to align with tracked docs.

3) docs/BALANCE_AND_TESTING.md
   - Documented manual run traces (decision dataset) and how to use the manual strategy in benchmarks.

4) .gitignore
   - Reorganized ignores so documentation and tests are tracked.
   - Left generated benchmark reports ignored:
     - docs/balance/
