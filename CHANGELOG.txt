================================================================================
ASTERIA GAME - CHANGELOG
================================================================================

--------------------------------------------------------------------------------
2026-01-25 - Shield Bar UI & Frost Barrier Implementation
--------------------------------------------------------------------------------

ISSUE:
- Frost Barrier ability (Lyra) was not applying shield effect when cast
- No visual indicator for active shields in the UI

CHANGES:

1. src/components/ui/HealthBar.tsx
   - Added optional `shield` prop to HealthBarProps interface
   - Shield bar renders below health bar only when shield > 0
   - Shield amount displayed in cyan next to HP values: "85 / 85 (+34)"
   - Shield bar uses cyan color scheme (bg-cyan-400 / bg-cyan-950)
   - Bar width calculated as percentage of max HP

2. src/components/combat/HeroPanel.tsx
   - Extract shield value from hero.statusEffects (type === "shield")
   - Pass shieldAmount to HealthBar component

3. src/systems/combat/turnManager.ts
   - Added processAbilityEffects() method
   - Processes ability tags after damage calculation
   - Handles "shield" tag: applies 40% max HP shield for 2 turns
   - Handles "burn" tag: applies 5% max HP DoT for 3 turns
   - Logs and animations queued for each effect applied

--------------------------------------------------------------------------------
2026-01-25 - Frost Barrier Shatter Fix & Bar Height Increase
--------------------------------------------------------------------------------

ISSUE:
- Frost Barrier was applying chill immediately on cast instead of on shatter
- Bar heights were too thin

CHANGES:

1. src/components/ui/HealthBar.tsx
   - Doubled health bar height: h-2 -> h-4
   - Doubled shield bar height: h-1.5 -> h-3

2. src/systems/combat/turnManager.ts
   - Removed immediate "chill" application from processAbilityEffects()
   - Added handleShieldShatter() method to trigger shatter effects
   - Shield now stores shatter damage in snapshotAtk field when created
   - processAbilityEffects() now receives abilityScaling parameter

   Shield break detection (executeMonsterAttack):
   - Captures existing shield and shatter damage before absorption
   - Detects when shield is fully absorbed (broken)
   - Calls handleShieldShatter() with reason "broken"

   Shield expire detection (endRound):
   - Captures existing shield and shatter damage before duration tick
   - Checks if "shield" appears in expired effects list
   - Calls handleShieldShatter() with reason "expired"

   handleShieldShatter() behavior:
   - Logs whether shield was "broken" or "expired"
   - Deals shatter damage to monster (based on ability scaling)
   - Applies Chill to monster (15% less damage for 2 turns)

NOTES:
- Frost Barrier now correctly follows its description:
  1. On cast: Creates shield absorbing 40% max HP (no damage)
  2. On shatter (broken OR expired): Deals shatter damage, applies Chill
- Shatter damage is pre-calculated on cast and stored on the shield effect

--------------------------------------------------------------------------------
2026-01-25 - Frost Barrier No Initial Damage Fix
--------------------------------------------------------------------------------

ISSUE:
- Frost Barrier was dealing damage on cast, but should only deal damage on shatter

CHANGES:

1. src/systems/combat/turnManager.ts (executeAbility)
   - Added isShieldAbility check: `ability.tags?.includes("shield")`
   - Shield abilities skip the immediate damage application
   - Damage is only dealt when handleShieldShatter() is called

NOTES:
- Frost Barrier behavior is now:
  1. On cast: Creates shield (40% max HP), NO damage
  2. On shatter: Deals 60-120% ATK damage + applies Chill

--------------------------------------------------------------------------------
2026-01-25 - Shield Bar Animation System
--------------------------------------------------------------------------------

ISSUE:
- Shield bar needed smooth animations for damage absorption, breaking, and expiration
- React state batching was causing animations to be skipped

CHANGES:

1. src/components/ui/HealthBar.tsx
   - Shows bar when shield is defined (including value 0)
   - Hides bar when shield becomes undefined
   - Shield text (+X) only shows when value > 0
   - CSS transition (duration-300) handles smooth animations

2. src/components/combat/HeroPanel.tsx
   - Passes `shieldEffect?.value` (undefined when no shield, 0 when broken)

3. src/systems/combat/statusEffects.ts (processShieldAbsorption)
   - Returns `shieldBroken` flag
   - When shield breaks, keeps it at value 0 (not removed immediately)

4. src/systems/combat/turnManager.ts (executeMonsterAttack)
   - When shield breaks: set value to 0, wait 350ms, then remove
   - This allows bar to animate to 0% before disappearing

5. src/systems/combat/turnManager.ts (endRound)
   - When shield expires: two-step animation with delays
   - Step 1: Keep shield at current value (show damage absorption)
   - Step 2: After 350ms, set value to 0 (show expiration drain)
   - Step 3: After 350ms, remove shield and trigger shatter

STATE FLOW (shield breaks):
1. Monster attacks, shield absorbs all remaining damage
2. Shield value set to 0 → bar animates to 0%
3. After 350ms → shield removed, bar disappears
4. Shatter effect triggers (damage + chill)

STATE FLOW (shield expires):
1. Monster attacks → shield absorbs partial damage (example: 28 → 22)
2. Bar animates to ~26% (damage absorption)
3. End of turn detects expiration, keeps shield at 22
4. After 350ms → shield value set to 0
5. Bar animates to 0% (expiration drain)
6. After 350ms → shield removed, bar disappears
7. Shatter effect triggers (damage + chill)


--------------------------------------------------------------------------------
2026-01-27 - Liquid Glass Panels & Turn Counter Carousel
--------------------------------------------------------------------------------

ISSUE:
- Hero/Monster panels needed a distinct "liquid glass" surface without changing the whole UI theme
- Turn counter animation was sliding the entire row instead of shifting the window (1 | 2 | 3 -> 2 | 3 | 4)

CHANGES:

1. src/app/globals.css
   - Added `.liquid-panel` class (blur + saturation + translucent background + highlight sheen)
   - Added `.liquid-tile` class for avatar tiles (smaller glass surface)

2. src/components/combat/HeroPanel.tsx
   - Switched panel container to `liquid-panel`
   - Switched avatar container to `liquid-tile`

3. src/components/combat/MonsterPanel.tsx
   - Switched panel container to `liquid-panel`
   - Switched avatar container to `liquid-tile`

4. src/components/combat/CombatHeader.tsx
   - Reworked turn counter into a slot-based carousel
   - Left value exits, remaining values shift left via layout animation, new value enters on the right
   - Uses smooth fade + slight blur for enter/exit to avoid hard motion

5. src/components/combat/ActionBar.tsx
   - Renamed local variable `useAbility` -> `castAbility` to avoid React Hooks lint false-positive
   - No functional change (still calls combatStore.useAbility)


--------------------------------------------------------------------------------
2026-01-28 - Run Loop (Victory -> Continue), Phase Router, Shop/Death Screens
--------------------------------------------------------------------------------

ISSUE:
- After winning, there was no reliable "continue" flow (player could get stuck in victory/combat_end).
- The app rendered CombatLayout for all phases, so shop/death/summary phases had no real screens.
- Skip Turn flipped to monster_turn but never executed the monster turn.

CHANGES:

1. src/systems/combat/combatActions.ts
   - proceedToNextEncounter() now guards: only works when phase is "victory" and turnPhase is "combat_end"
   - When continuing directly to combat: resets encounter UI state (clearLog + resetTurn) before spawning next monster
   - Added performSkipTurn() to ensure skipping schedules the monster turn (same delay as normal hero->monster transition)

2. src/components/combat/ActionBar.tsx
   - Skip Turn button now calls performSkipTurn() (fixes "stuck in monster_turn" bug)

3. src/systems/combat/turnManager.ts
   - executeMonsterTurn() now hard-guards against stale timeouts:
     - returns early unless game.phase === "combat" and turnPhase === "monster_turn"

4. src/app/page.tsx
   - Added phase-based routing:
     - combat/victory: CombatLayout
     - shop: ShopScreen
     - death: DeathScreen
     - run_summary: RunSummaryScreen
     - hero_select: placeholder hero/difficulty picker

5. src/components/screens/ShopScreen.tsx
   - WIP shop screen with guaranteed escape hatch:
     - Continue to Fight (no encounter increment)
     - Skip Shop (increments shopsSkipped, then continues)

6. src/components/screens/DeathScreen.tsx
   - Minimal death screen with run stats and actions:
     - Try Again
     - Hero Select

7. src/components/screens/RunSummaryScreen.tsx
   - Minimal summary screen for ending a run intentionally:
     - Start New Run
     - Hero Select


--------------------------------------------------------------------------------
2026-01-28 - Victory UI (In-Arena Card, No Modal Overlay)
--------------------------------------------------------------------------------

ISSUE:
- Victory UI as a modal overlay felt heavy and could interfere with the layout.
- Victory panel size was pushing side panels.

CHANGES:

1. src/components/combat/BattleArena.tsx
   - Replaced the portrait/VS block with a centered Victory card when:
     - game.phase === "victory" AND turnPhase === "combat_end"
   - Buttons:
     - Next Encounter / Enter Shop (computed from next encounter + shop frequency)
     - End Run
   - Later tweaks:
     - Reduced width (max-w-md) and padding to avoid pushing side columns
     - Removed the extra run info block per UX feedback

2. src/components/combat/CombatLayout.tsx
   - Removed VictoryOverlay mount

3. src/components/combat/VictoryOverlay.tsx
   - Deleted (no longer used)


--------------------------------------------------------------------------------
2026-01-28 - Camira Full Kit Implementation
--------------------------------------------------------------------------------

ISSUE:
- Camira's passive and all abilities were defined in data but not implemented in combat.

CHANGES:

1. src/systems/combat/turnManager.ts
   - Implemented Camira:
     - Passive: every 3rd BASIC attack deals bonus damage
     - Passive: on crit restores 2-5 mana and reduces Rapid Fire cooldown by 1
     - Rapid Fire: two hits + lifesteal based on total damage
     - Forest Agility: evade buff for next incoming attack + permanent ATK/DEF, and level 5+ random permanent Max HP
     - Jackpot Arrow: extra penetration, crit stacking per use, bonus crystals on kill
   - Ensured evade is consumed after the next monster attack attempt


--------------------------------------------------------------------------------
2026-01-28 - Long-Term Combat Architecture Refactor (Ability/Passive Registries)
--------------------------------------------------------------------------------

ISSUE:
- TurnManager was starting to accumulate hero-specific branching (not scalable when adding heroes).
- Ability tags were freeform strings, so typos or unimplemented tags silently did nothing.
- Mixing orchestration (turn flow) with ability mechanics makes future features harder to add and test.

WHY THIS CHANGE:
- Separates "combat flow" from "content logic" so adding heroes is mostly adding data + small handlers.
- Creates a single place to implement shared mechanics (tags) once and reuse across heroes.
- Adds compile-time safety for tags, preventing silent no-ops from typos.

CHANGES:

1. src/types/common.ts
   - Added AbilityTag union type to define the allowed set of ability tags

2. src/types/hero.ts
   - Ability.tags now uses AbilityTag[] instead of string[]

3. New: src/systems/combat/abilities/registry.ts
   - Ability-id registry for custom abilities (currently holds Camira handlers)
   - Allows future heroes to add complex mechanics without bloating TurnManager

4. New: src/systems/combat/abilities/tags.ts
   - Tag handler registry for reusable effects
   - Migrated existing tag behaviors:
     - burn
     - shield

5. New: src/systems/combat/abilities/types.ts
   - Shared types for ability execution context/handlers

6. New: src/systems/combat/passives/registry.ts
   - Passive hook registry (by heroId)
   - Camira passive moved here (onCrit + onBasicAttackResolved)

7. New: src/systems/combat/passives/types.ts
   - Passive hook types (onCrit, onBasicAttackResolved)

8. src/systems/combat/turnManager.ts
   - Removed Camira-specific branching from core flow
   - Execution now:
     - Checks abilityRegistry[ability.id] for custom handlers
     - Otherwise runs generic damage pipeline + applyAbilityTags(tags)
     - Passive hooks fire via triggerOnCrit / triggerOnBasicAttackResolved


--------------------------------------------------------------------------------
2026-01-28 - Build / TypeScript Fixes
--------------------------------------------------------------------------------

ISSUE:
- next build failing due to type errors and missing MonsterType keys.

CHANGES:

1. src/systems/combat/statusEffects.ts
   - Bleed tick now guards snapshotAtk (undefined -> 0) to satisfy TS and prevent runtime NaNs

2. src/data/monsters/definitions.ts
   - Added missing monster definitions/exports for vampire/orc/dragon and included them in MONSTERS

--------------------------------------------------------------------------------
2026-01-28 - Testing Infrastructure, Balance Tools & Score System Refactor
--------------------------------------------------------------------------------

ISSUE:
- Camira kit had text/value mismatches for Jackpot Arrow and Passive triggers
- No way to verify hero balance or mechanic implementation without manual play
- Score system was flat (10 points per kill), making monster types irrelevant for scoring
- No automated testing suite configured

CHANGES:

1. HERO REFINEMENT (Camira)
   - Updated `src/data/heroes/camira.ts`: Fixed Jackpot Arrow crystal text (20-600 vs 25-1600)
   - Updated `src/data/heroes/camira.ts`: Clarified passive text to "Every 3rd basic attack"
   - Added comprehensive unit tests in `tests/camira.test.ts` for all abilities/passives

2. SIMULATION & BALANCE ENGINE
   - Created `tests/utils/simulation.ts`: Headless game loop for high-speed automated runs
   - Implemented smart decision engine for Camira (kill-range detection, mana reservation)
   - Added `tests/benchmark.test.ts`: automated multi-strat benchmark suite
   - Added `docs/BALANCE_AND_TESTING.md`: Documentation for balance workflows
   - Configured auto-report generation in `docs/balance/` for hero analysis

3. SCORE SYSTEM REFACTOR
   - Updated `src/types/monster.ts`: Added `score` to base stats and `scoreReward` to state
   - Updated `src/data/monsters/definitions.ts`: Implemented unique scores per monster type
   - Updated `src/stores/combatStore/monsterSlice.ts`: Wired monster score to runtime state
   - Updated `src/systems/combat/turnManager.ts`: Refactored victory scoring:
     `score = monster.scoreReward * difficultyMultiplier`

4. COMBAT ENGINE INSTRUMENTATION
   - Added logging for dodged/missed abilities in `TurnManager.ts` and `registry.ts`
   - Improved log parsing in simulation to track crits, dodges, and jackpot efficiency

5. PROJECT CLEANUP
   - Standardized on `vitest.config.mts`, removed duplicate config
   - Added `benchmark` and `benchmark:hero` scripts to `package.json`
   - Cleaned up build artifacts and updated `.gitignore`
